FROM public.ecr.aws/amazonlinux/amazonlinux:2023

# curl-minimal を削除して curl などの依存関係をインストール
RUN rpm -e --nodeps curl-minimal \
 && dnf install -y curl wget tar gzip jq libicu libunwind \
 && dnf clean all

# PowerShell (x86_64) のインストール
RUN curl -L https://github.com/PowerShell/PowerShell/releases/download/v7.4.13/powershell-7.4.13-linux-x64.tar.gz -o /tmp/powershell.tar.gz && \
    mkdir -p /opt/microsoft/powershell/7 && \
    tar zxf /tmp/powershell.tar.gz -C /opt/microsoft/powershell/7 && \
    chmod +x /opt/microsoft/powershell/7/pwsh && \
    ln -s /opt/microsoft/powershell/7/pwsh /usr/bin/pwsh && \
    rm /tmp/powershell.tar.gz

# PowerShell モジュールのインストール
RUN pwsh -Command "& { \
    Set-PSRepository -Name 'PSGallery' -InstallationPolicy Trusted; \
    Install-Module -Name AWS.Tools.Common -Force -Scope AllUsers -RequiredVersion 5.0.104; \
    Install-Module -Name AWS.Tools.Lambda -Force -Scope AllUsers -RequiredVersion 5.0.104; \
    Install-Module -Name AWS.Tools.S3 -Force -Scope AllUsers -RequiredVersion 5.0.104; \
    Install-Module -Name AWS.Tools.SimpleSystemsManagement -Force -Scope AllUsers -RequiredVersion 5.0.104; \
    Install-Module -Name Microsoft.Graph -Force -Scope AllUsers -RequiredVersion 2.32 \
}"

# 起動スクリプトを配置
COPY src/entrypoint.ps1 /entrypoint.ps1
RUN chmod +x /entrypoint.ps1

# PowerShell をデフォルトシェルに
ENTRYPOINT ["pwsh", "/entrypoint.ps1"]
