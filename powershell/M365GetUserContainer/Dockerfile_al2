FROM public.ecr.aws/amazonlinux/amazonlinux:2.0.20250818.2-arm64v8

# PowerShell (ARM64) のインストール
RUN yum install -y wget tar gzip curl jq icu && yum clean all && \
    curl -L https://github.com/PowerShell/PowerShell/releases/download/v7.4.4/powershell-7.4.4-linux-arm64.tar.gz -o /tmp/powershell.tar.gz && \
    mkdir -p /opt/microsoft/powershell/7 && \
    tar zxf /tmp/powershell.tar.gz -C /opt/microsoft/powershell/7 && \
    chmod +x /opt/microsoft/powershell/7/pwsh && \
    ln -s /opt/microsoft/powershell/7/pwsh /usr/bin/pwsh && \
    rm /tmp/powershell.tar.gz

# PowerShell モジュールのインストール
RUN pwsh -Command "& { \
    Set-PSRepository -Name 'PSGallery' -InstallationPolicy Trusted; \
    Install-Module -Name AWS.Tools.Common -Force -Scope AllUsers; \
    Install-Module -Name AWS.Tools.Lambda -Force -Scope AllUsers; \
    Install-Module -Name AWS.Tools.S3 -Force -Scope AllUsers; \
    Install-Module -Name AWS.Tools.SimpleSystemsManagement -Force -Scope AllUsers; \
    Install-Module -Name Microsoft.Graph -Force -Scope AllUsers \
}"

# 起動スクリプトを配置
COPY src/entrypoint.ps1 /entrypoint.ps1
RUN chmod +x /entrypoint.ps1

# PowerShell をデフォルトシェルに
ENTRYPOINT ["pwsh", "/entrypoint.ps1"]